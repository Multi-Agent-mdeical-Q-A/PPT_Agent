# é¡¹ç›®æ¶æ„ç¬”è®°ï¼šBatch-Optimized Agentic CRAG (v1.1 - Observability Enhanced)

## 1. é¡¹ç›®ç›®æ ‡ (Project Goals)
- **æ ¸å¿ƒä»»åŠ¡**ï¼šé‡æ„ CRAG ä»£ç ä¸ºæ¨¡å—åŒ– Agent ç³»ç»Ÿã€‚
- **è¿è¡Œç­–ç•¥**ï¼š**ç¦»çº¿æ‰¹å¤„ç† (Offline Batching)**ã€‚è¿½æ±‚ GPU é«˜ååé‡ã€‚
- **è·¯ç”±æœºåˆ¶**ï¼šæ”¯æŒ No Retrieval / Naive RAG / CRAG ä¸‰ç§ç­–ç•¥ã€‚
- **æˆåŠŸæŒ‡æ ‡**ï¼šPopQA/PubQA æ•°æ®é›† **100% å¤ç°** è®ºæ–‡åˆ†æ•°ã€‚
- **ã€æ–°å¢ã€‘å¯è§‚æµ‹æ€§ç›®æ ‡**ï¼š
    - **å…¨é“¾è·¯è¿½è¸ª**ï¼šå³ä½¿åœ¨ Batch æ¨¡å¼ä¸‹ï¼Œä¹Ÿèƒ½é€šè¿‡ `request_id` æ£€ç´¢åˆ°ä»»ä½•ä¸€ä¸ªå•ä½“ Query çš„å®Œæ•´å¤„ç†è·¯å¾„ï¼ˆæ£€ç´¢äº†ä»€ä¹ˆã€æ‰“äº†å¤šå°‘åˆ†ã€ç”Ÿæˆçš„ Prompt é•¿ä»€ä¹ˆæ ·ï¼‰ã€‚
    - **Bad Case åˆ†æ**ï¼šèƒ½å¤Ÿé€šè¿‡å¯è§†åŒ–ç•Œé¢ï¼ˆå¦‚ Arize Phoenixï¼‰å¿«é€Ÿå®šä½åˆ†æ•°ä½çš„é—®é¢˜æ˜¯å“ªä¸ªç¯èŠ‚å‡ºäº†é”™ã€‚
---

## 2. æ¡†æ¶åˆ†å±‚ (Architecture Layers)
ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼ˆæ°´å¹³ï¼‰+ ä¸€ä¸ªè¿½è¸ªåˆ‡é¢ï¼ˆå‚ç›´ï¼‰ã€‚

### ğŸ§± I. Data Layer (æ•°æ®å±‚ - èº«ä»½èµ‹äºˆè€…)
- **æ ¸å¿ƒç»„ä»¶ `loader.py`**ï¼š
    - **èŒè´£æ›´æ–°**ï¼šé™¤äº†è¯»å–æ•°æ®ï¼Œå¿…é¡»ä¸ºæ¯ä¸€æ¡æ•°æ®åˆ†é…ï¼ˆæˆ–æå–ï¼‰å”¯ä¸€çš„ **`request_id`**ã€‚
    - **è¾“å‡ºæ ¼å¼**ï¼š`BatchData` å¯¹è±¡ç°åœ¨åŒ…å«ï¼š
        - `ids`: `List[str]` (å”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¦‚ "popqa_1024")
        - `queries`: `List[str]`
        - `golds`: `List[str]` (æ ‡å‡†ç­”æ¡ˆï¼Œç”¨äºåç»­è¯„æµ‹)
        - `raw_docs`: `List[str]` (é¢„å¤„ç†å¥½çš„æ£€ç´¢æ–‡æ¡£)

### ğŸ› ï¸ II. Core Layer (èƒ½åŠ›å±‚ - æºå¸¦ ID çš„å·¥å…·)
- **è®¾è®¡åŸåˆ™æ›´æ–°**ï¼šæ‰€æœ‰çš„ `run` æ–¹æ³•é™¤äº†æ¥æ”¶æ•°æ®åˆ—è¡¨ï¼Œ**å»ºè®®æ¥æ”¶å¯¹åº”çš„ `ids` åˆ—è¡¨**ï¼ˆç”¨äºæ—¥å¿—è®°å½•ï¼‰ï¼Œæˆ–è€…é€šè¿‡è£…é¥°å™¨è‡ªåŠ¨æ•è·ã€‚
- **æ ¸å¿ƒç»„ä»¶**ï¼š
    - **`base_tool.py`**ï¼šå¢åŠ  `@trace_tool` è£…é¥°å™¨é€»è¾‘ã€‚
        - **é€»è¾‘**ï¼šå½“ `run(inputs, ids)` è¢«è°ƒç”¨æ—¶ï¼Œè£…é¥°å™¨ä¼šè‡ªåŠ¨å°† `inputs` å’Œ `ids` è¿›è¡Œ zip é…å¯¹ï¼Œå¹¶å°†æ¯ä¸€å¯¹çš„ è¾“å…¥/è¾“å‡º/è€—æ—¶ å‘é€ç»™è¿½è¸ªç³»ç»Ÿã€‚
    - **`evaluator_tool.py`** / **`generator_tool.py`**ï¼š
        - å†…éƒ¨é€»è¾‘ä¸å˜ï¼ˆä¾ç„¶æ˜¯ GPU Batch è®¡ç®—ï¼‰ã€‚
        - ä½†åœ¨æ—¥å¿—å±‚é¢ï¼Œå®ƒä»¬ä¸å†æ˜¯â€œå¤„ç†äº†ä¸€ä¸ªå¤§æ•°ç»„â€ï¼Œè€Œæ˜¯â€œåŒæ—¶å¤„ç†äº† N ä¸ª ID çš„è¯·æ±‚â€ã€‚

### ğŸ§  III. Control Layer (æ§åˆ¶å±‚ - é€»è¾‘ç¼–æ’)
- **`crag_agent.py`**ï¼š
    - **èŒè´£æ›´æ–°**ï¼šè´Ÿè´£é€ä¼  `ids`ã€‚
    - **é€»è¾‘æµ**ï¼š
        1. Agent æ¥æ”¶ `(ids, queries, docs)`ã€‚
        2. è°ƒç”¨ `Evaluator(queries, docs, ids=ids)`ã€‚ -> **Trace è®°å½•è¯„åˆ†è¯¦æƒ…**ã€‚
        3. é€»è¾‘åˆ†æµï¼šè®¡ç®— `flags`ã€‚ -> **Trace è®°å½•æ¯ä¸ª ID çš„è·¯ç”±å†³ç­– (Correct/Incorrect)**ã€‚
        4. æ‹¼å‡‘ Contextã€‚
        5. è°ƒç”¨ `Generator(prompts, ids=ids)`ã€‚ -> **Trace è®°å½•æœ€ç»ˆ Prompt å’Œç”Ÿæˆç»“æœ**ã€‚

### ğŸ“¡ IV. Tracing & Utils (è¿½è¸ªåˆ‡é¢ - æ–°å¢)
- **å®šä¹‰**ï¼šä¸€å¥—è½»é‡çº§çš„æ—¥å¿—åŸ‹ç‚¹ç³»ç»Ÿï¼Œå»ºè®®æ¥å…¥ **Arize Phoenix** (å¼€æºã€æœ¬åœ°è¿è¡Œã€é€‚åˆ Batch) æˆ– **LangSmith**ã€‚
- **æ ¸å¿ƒç»„ä»¶ `tracing.py`**ï¼š
    - **`TraceManager`**ï¼šåˆå§‹åŒ–è¿½è¸ªå™¨ï¼ˆClientï¼‰ã€‚
    - **`@trace_batch` è£…é¥°å™¨**ï¼š
        - è¿™æ˜¯å®ç° Batch å¯è§‚æµ‹æ€§çš„é»‘ç§‘æŠ€ã€‚
        - å®ƒæ‹¦æˆªå‡½æ•°çš„è¾“å…¥ï¼ˆListï¼‰å’Œè¾“å‡ºï¼ˆListï¼‰ã€‚
        - å®ƒéå† Listï¼Œå°† Batch æ‹†è§£ä¸º N æ¡ç‹¬ç«‹çš„ Span è®°å½•ï¼Œå‘é€ç»™å¯è§†åŒ–å¹³å°ã€‚
        - **æ”¶ç›Š**ï¼šä½ åœ¨åå°è·‘çš„æ˜¯ Batchï¼Œä½†åœ¨ç½‘é¡µç•Œé¢ä¸Šçœ‹åˆ°çš„æ˜¯ä¸€æ¡æ¡æ¸…æ™°ç‹¬ç«‹çš„ Traceã€‚
---

## 3. æ›´æ–°åçš„ä»£ç æ–‡ä»¶ç»“æ„

```Plaintext
my_agentic_rag/
â”œâ”€â”€ data_layer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ loader.py               # [æ›´æ–°] è¿”å›åŒ…å« 'ids' çš„ BatchData
â”‚   â””â”€â”€ metrics.py
â”‚
â”œâ”€â”€ core_layer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_tool.py            # [æ›´æ–°] é›†æˆ @trace_batch è£…é¥°å™¨
â”‚   â”œâ”€â”€ evaluator_tool.py       # run(..., ids=ids)
â”‚   â”œâ”€â”€ generator_tool.py       # run(..., ids=ids)
â”‚   â””â”€â”€ refiner_tool.py
â”‚
â”œâ”€â”€ control_layer/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ prompt_builder.py
â”‚   â””â”€â”€ crag_agent.py           # [æ›´æ–°] åœ¨è°ƒç”¨å·¥å…·æ—¶é€ä¼  ids
â”‚
â”œâ”€â”€ utils/                      # [æ–°å¢]
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ tracing.py              # [æ–°å¢] å°è£… Phoenix/LangSmith Client å’Œè£…é¥°å™¨é€»è¾‘
â”‚
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.yaml
â”‚
â”œâ”€â”€ main.py                     # [å…¥å£] å¯åŠ¨ Phoenix Serverï¼Œè¿è¡Œ Pipeline
â””â”€â”€ README.md
```
---

## 4. å®æ–½ç»†èŠ‚å»ºè®®

### æ¨èå·¥å…·ï¼šArize Phoenix
å¯¹äºç§‘ç ”å’Œç¦»çº¿å¤ç°ï¼Œæ¨èä½¿ç”¨ **Arize Phoenix**ã€‚
- **ç†ç”±**ï¼š
    1. **æœ¬åœ°è¿è¡Œ**ï¼šä¸éœ€è¦è”ç½‘å‘æ•°æ®ç»™ SaaSï¼Œæ•°æ®éšç§å®‰å…¨ï¼Œé€Ÿåº¦æå¿«ã€‚
    2. **Pandas å‹å¥½**ï¼šå®ƒå¯ä»¥ç›´æ¥æŠŠ Trace å¯¼å‡ºæˆ Pandas DataFrameï¼Œæ–¹ä¾¿ä½ åç»­åšæ‰¹é‡åˆ†æï¼ˆæ¯”å¦‚ï¼šâ€œç»Ÿè®¡æ‰€æœ‰åˆ†æ•° < 0 çš„ Prompt é•¿åº¦åˆ†å¸ƒâ€ï¼‰ã€‚
    3. **å¯è§†åŒ–**ï¼šæä¾›ç±»ä¼¼ LangSmith çš„ Web UIã€‚

### è£…é¥°å™¨ä¼ªä»£ç ç¤ºä¾‹ (`utils/tracing.py`)

```Python

import functools
from phoenix.trace.dsl import Span

def trace_batch(tool_name):
    def decorator(func):
        @functools.wraps(func)
        def wrapper(self, inputs, ids=None, **kwargs):
            # 1. æ‰§è¡ŒåŸå‡½æ•° (Batch è®¡ç®—)
            outputs = func(self, inputs, **kwargs)
            
            # 2. å¦‚æœæœ‰ IDsï¼Œè¿›è¡Œæ‹†è§£è®°å½• (Side Effectï¼Œä¸å½±å“ä¸»æµç¨‹)
            if ids:
                for i, _id in enumerate(ids):
                    # è¿™é‡Œæ˜¯ä¼ªä»£ç ï¼Œå…·ä½“è¯­æ³•å‚è€ƒ Phoenix æ–‡æ¡£
                    # è®°å½•æ¯ä¸€æ¡æ•°æ®çš„ è¾“å…¥ -> è¾“å‡º æ˜ å°„
                    with Span(name=tool_name, id=_id, input=inputs[i]):
                        pass # è®°å½• output[i]
            
            return outputs
        return wrapper
    return decorator
```
